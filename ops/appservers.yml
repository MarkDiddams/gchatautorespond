---

- hosts: appservers
  remote_user: "{{ appuser }}"
  vars_files:
      - secrets.yml
  vars:
      - pydrive_key: "{{ lookup('file', '../secrets/pydriveprivatekey.pem') }}"
  roles:
    - role: common
    - role: Yannik.enable-standard-cronjobs
      sudo: true
    - role: jnv.unattended-upgrades
      sudo: true
    - role: ricbra.logentries
      sudo: true
      tags: logentries
    - role: Stouts.backup
      sudo: true
      tags: backup
      backup_profiles:
        - name: gchat_db3
          schedule: "0 18 * * *"
          source: "{{ approot }}"
          exclude:
             - "{{ assetdir }}"
             - "{{ appdir }}"
             - "{{ deploydir }}"
             - "{{ venv }}"
          target: "pydrive://{{ pydrive_user }}/gchat_backups/db3"
          action: 'backup_verify_purge --force'
    - role: sivel.newrelic
      sudo: yes
    - ANXS.python
    - runapp
